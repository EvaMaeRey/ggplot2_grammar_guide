---
title: "multiple series"
author: "Gina Reynolds"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["xaringan-themer.css", "ninjutsu"]
    nature:
      highlightLines: yes
      ratio: '16:9'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
knitr::opts_chunk$set(fig.height = 6, out.width = "100%", comment = " ", cache = T, dpi = 300)
library(flipbookr)
options(scipen = 10)
```


```{r}
library(tidyverse)
library(gapminder)
```


---
class: inverse, center, middle
name: mult_series


## a few series


---

`r chunk_reveal("time_series_multi_build", width_code = "49%", width_output = "50%")`

```{r time_series_multi_build, include=F}
gapminder %>% 
  filter(continent == "Oceania") %>% 
  mutate(gdp = pop * gdpPercap) %>% 
  ggplot() +
  aes(x = year) +
  aes(y = gdp) +
  geom_point()
```


---

`r chunk_reveal("time_series_multi", break_type = "rotate", width_code = "49%", width_output = "50%")`

```{r time_series_multi, include=F}
gapminder %>% 
  filter(continent == "Oceania") %>% 
  mutate(gdp = pop * gdpPercap) %>% 
  ggplot() +
  aes(x = year) +
  aes(y = gdp) +
  geom_point() +
  geom_line(aes(linetype = country, color = country)) + #ROTATE
  ggforce::geom_bspline(aes(linetype = country)) + #ROTATE
  geom_col(aes(fill = country), position = "dodge", alpha = .4) + #ROTATE
  geom_col(aes(fill = country), alpha = .4) + #ROTATE
  geom_area(aes(fill = country), alpha = .4) + #ROTATE
  theme_minimal()
```

---






---
class: inverse, center, middle

# Many series



---



`r chunk_reveal("aes_group", width_code = "49%", width_output = "50%")`


```{r aes_group, eval = F, echo = F}
gapminder %>% 
  filter(continent %in% c("Americas", "Oceania")) %>% 
  ggplot() +
  aes(x = year) +
  aes(y = lifeExp) +
  geom_point() +
  geom_line() +
  aes(color = country) +
  scale_color_discrete(guide = F) +
  aes(color = NULL) +
  aes(group = country) +
  geom_point(data = . %>% # using global data
               filter(country %in% # filtering to 
                       c("New Zealand","Chile")), # NZ and  Chile
             color = "plum4",
             size = 4) +
  geom_line(data = . %>% 
              filter(country %in% 
                       c("New Zealand","Chile")), 
            color = "plum4",
            size = 2) +
  geom_text(data = . %>% 
              filter(country %in% 
                       c("New Zealand","Chile")) %>% 
              group_by(country) %>% 
              slice(3),
            aes(label = country),
            nudge_y = 2, hjust = .7, 
            color = "plum4", size = 5, 
            fontface = "bold")
```

---

`r chunk_reveal("difference_ribbon", width_code = "49%", width_output = "50%")`


```{r difference_ribbon, eval = F, echo = F}
gapminder %>%
  filter(continent == "Oceania") %>% 
  mutate(pop_millions = pop/1000000) ->
gm_oceania

gm_oceania %>%
  select(-gdpPercap, -lifeExp, - pop) %>% 
  pivot_wider(names_from = country,
              values_from = pop_millions) ->
gm_oceania_pop_millions_wide
  
gm_oceania %>% # global data
  ggplot() +
  aes(x = year) +
  aes(y = pop_millions) +
  geom_line(aes(linetype = country),
            color = "plum4") +
  geom_ribbon(data = gm_oceania_pop_millions_wide, # local data
              aes(ymin = `New Zealand`, # poorly named var like this one has space
                  ymax = Australia,     # must be surrounded by back ticks
                  y = NULL), # without this geom ribbon is wondering about y equals year
              fill = "plum4",
              alpha = .1) +
  scale_y_continuous(limits = c(0, 22))
```

---

`r chunk_reveal("growth", width_code = "49%", width_output = "50%")`


```{r growth, eval = F, echo = F}
gapminder %>%
  filter(continent == "Europe") %>% 
  filter(year %in% c(1972, 2002)) %>% 
  mutate(country = reorder(country, lifeExp, mean)) ->
gap_72_02_europe

gap_72_02_europe %>% 
  select(-gdpPercap, -pop) %>% 
  pivot_wider(names_from = year,
              values_from = lifeExp) ->
gap_72_02_europe_wide

ggplot(data = gap_72_02_europe) +
  aes(x = lifeExp) +
  aes(y = country) +
  geom_point() +
  aes(color = factor(year)) +
  geom_segment(data = gap_72_02_europe_wide,
               # poorly named columns ie starting w number
               # need to be surrouned by backtick
                 aes(x = `1972`, 
                     xend = `2002`, 
                     yend = country),
               color = "plum3",
               size = 1.5) +
  # point layer above not really needed - just for showing logic
  geom_point(size = 4) + 
  scale_color_manual(values = c("plum3", "plum4")) +
  theme(legend.position = c(.15,.85)) +
  labs(color = NULL, y = NULL)
```




---
name: group

## The group aesthetic and geometric objects


---

Using geom_line(), you can use many of the same aesthetics as before as well as one special aesthetic: `group`.

> Lines and paths fall somewhere in between: each overall line is composed of a set of straight segments, but each segment represents two points. --- Hadley Wickham


Group is like a declaration that instead of plotting the entire data set all together, instead you will plot many small data sets, each defined by the categorical variable "mapped" to `group`.  

Let's see how this works with the following example. 

---
name: many_series
class: inverse, middle, center


# Many series


---

The geometric object `line` connects all points as it moves along the x axis.  If a group is not defined, the geom_line is hard to interpret, as seen before group is added.  

We also see that mapping discrete data to the color or linetype aesthetics has a similar effect to declaring that there are groups in the data. 

Another thing we observe in the last addition to the last plot is adding an additional geometric layer.  The point layer, because it follows the line layer, appears on top of the line layer.  





---

`r chunk_reveal("time_series_heat", break_type = "auto")`

```{r time_series_heat, include=F}
gapminder %>% 
  filter(continent == "Europe") %>% 
  ggplot() +
  aes(x = factor(year)) +
  aes(y = country) +
  geom_tile(color = "grey80") +
  aes(fill = lifeExp) +
  scale_fill_viridis_c(option = "magma")
```


---

`r chunk_reveal("polar_bar")`

```{r polar_bar, include = F}
gapminder %>% 
  filter(continent == "Oceania") %>% 
  mutate(pop_millions = pop/1000000) %>% 
  arrange(-pop) %>% 
  ggplot() +
  aes(x = year) +
  aes(y = pop_millions) +
  geom_col(width = 4, position = "dodge") +
  coord_polar() +  
  scale_y_continuous(limits = c(-10, 25)) +
  scale_x_continuous(breaks = seq(1952, 2007, by = 5), 
                     limits = c(1950, 2010)) +
  aes(fill = country) +
  geom_text(data = . %>% 
              filter(country == "Australia"),
            aes(label = year,
                y = pop_millions + 3),
            fontface = "bold",
            color = "navy") +
  theme_void() + 
  theme(legend.position = c(.8,.8)) +
  labs(fill = NULL)
```


---

# ranks of a series

---

`r chunk_reveal("time_series_bump", break_type = "auto", width_code = "49%", width_output = "50%")`

```{r time_series_bump, include=F}
gapminder %>% 
  filter(country %in% c("Austria", "Belgium", 
                        "Norway", "Netherlands",
                        "Spain", "Italy","France")) %>%
  filter(year > 1980) %>% 
  group_by(year) %>% 
  arrange(lifeExp) %>% 
  mutate(rank_life_exp = 1:n()) %>% 
  ungroup() %>% 
  ggplot() +
  aes(x = year) +
  aes(y = rank_life_exp) +
  geom_point(size = 6) +
  aes(color = country) +
  ggbump::geom_bump(size = 2, smooth = 8) +
  scale_x_continuous(limits = c(1970, 2020),
                     breaks = seq(1982, 2007, 
                                  by = 5)) +
  geom_text(data = . %>% 
              filter(year == min(year)),
            aes(x = year - 2.5, label = country), 
            size = 5, hjust = 1) +
  geom_text(data = . %>% 
              filter(year == max(year)),
            aes(x = year + 2.5, label = country), 
            size = 5, hjust = 0) +
  scale_color_manual(values = paletteer::paletteer_d("basetheme::brutal", 7)) +
  theme_minimal() +
  theme(legend.position = "none")
```

---

`r chunk_reveal("time_series_bump_line", break_type = 1, width_code = "49%", width_output = "50%")`

```{r time_series_bump_line, include=F}
gapminder %>% 
  filter(country %in% c("Austria", "Belgium", 
                        "Norway", "Netherlands",
                        "Spain", "Italy","France")) %>%
  filter(year > 1980) %>% 
  group_by(year) %>% 
  arrange(lifeExp) %>% 
  mutate(rank_life_exp = 1:n()) %>% 
  ungroup() %>% 
  ggplot() +
  aes(x = year) +
  aes(y = rank_life_exp) +
  aes(color = country) +
  geom_line(size = 2, smooth = 8) + #<<
  geom_point(size = 6, shape = 21, fill = "white", stroke = 2) + #<<
  scale_x_continuous(limits = c(1970, 2020),
                     breaks = seq(1982, 2007, 
                                  by = 5)) +
  geom_text(data = . %>% 
              filter(year == min(year)),
            aes(x = year - 2.5, label = country), 
            size = 5, hjust = 1) +
  geom_text(data = . %>% 
              filter(year == max(year)),
            aes(x = year + 2.5, label = country), 
            size = 5, hjust = 0) +
  scale_color_manual(values = paletteer::paletteer_d("basetheme::brutal", 7)) +
  theme_minimal() +
  theme(legend.position = "none")
```


---

`r chunk_reveal("slope_plot", width_code = "60%", width_output = "39%")`

```{r slope_plot, include=F}
gapminder %>% 
  filter(country %in% c("Belgium", "Norway", "Spain")) %>%
  filter(year > 1990) %>% 
  ggplot() +
  aes(x = year) +
  aes(y = lifeExp) +
  aes(color = country) +
  geom_line(size = 2, smooth = 8) + 
  geom_label(aes(label = round(lifeExp, 1)),
             color = "darkgrey", stroke = "red", check_overlap = T) + 
  scale_x_continuous(limits = c(1985, 2012), breaks = seq(1992, 2007, by = 5)) +
  geom_text(data = . %>% filter(year == min(year)),
            aes(x = year - 1.5, label = country), 
            size = 5, hjust = 1) +
  geom_text(data = . %>% filter(year == max(year)),
            aes(x = year + 1.5, label = country), 
            size = 5, hjust = 0) +
  scale_color_manual(values =  paletteer::paletteer_d("basetheme::brutal", 7)) +
  theme_minimal() +
  theme(panel.grid.major.y = element_blank()) +
  theme(panel.grid.minor.y = element_blank()) +
  theme(panel.grid.minor.x = element_blank()) +
  theme(panel.grid.major.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks.y = element_blank()) +
  theme(legend.position = "none") +
  labs(x = NULL, y = NULL)
```


---

`r chunk_reveal("waffle", width_code = "60%", width_output = "39%")`

```{r waffle, include = F}
gapminder %>%  
  filter(continent == "Oceania") %>%  
  ggplot() +  
  waffle::geom_waffle(aes(values = pop/1000000, 
                          fill = country), 
                      color = "white", 
                      size = .25, 
                      n_rows = 3, flip = T) +
  coord_equal() +  
  facet_wrap(~ year, nrow = 1, strip.position = "bottom") +  
  theme_void() +
  labs(title = "Population (millions)") +
  labs(fill = NULL) +
  theme(legend.position = "bottom")
```


---

[Racing bar chart](https://evamaerey.github.io/flipbooks/racing_bars/racing_barcharts.html#34) is concerned with ranks and values.




---

<!-- --- -->
<!-- class: middle, center, inverse -->

<!-- # geom stats -->

<!-- -- -->

<!-- ### identity -->

<!-- -- -->


<!-- ### count -->


<!-- --- -->



<!-- ```{r stat, include=F} -->
<!-- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-03/game_goals.csv') -> -->
<!--   game_goals -->

<!-- game_goals %>%  -->
<!--   count(season) %>%  -->
<!--   full_join(tibble(season = 1980:2020)) %>%  -->
<!--   ggplot() + -->
<!--   aes(x = season) + -->
<!--   aes(y = n) + -->
<!--   geom_col() + # stat is identity -->
<!--   geom_point() + # stat is identity -->
<!--   geom_line() + # stat is identity -->
<!--   geom_area(alpha = .2, # stat is identity -->
<!--             fill = "magenta") + -->
<!--   aes(fill = season) + -->
<!--   aes(xend = season) +  -->
<!--   aes(yend = 0) + -->
<!--   geom_segment(linetype = "dotted") -> -->
<!-- you_aggregate_then_plot -->

<!-- game_goals %>% -->
<!--   ggplot() + -->
<!--   aes(x = season) + -->
<!--   geom_bar() + # a version of geom column -->
<!--   geom_point(stat = "count") + -->
<!--   geom_line(stat = "count") + -->
<!--   geom_area(stat = "count", -->
<!--             alpha = .2, -->
<!--             fill = "magenta") + -->
<!--   aes(fill = season) -> # not completely grasping why fill cant work here -->
<!-- ggplot_aggregates_for_you -->
<!-- ``` -->


<!-- --- -->


<!-- ```{r bar_discrete_continuous, include = F} -->
<!-- tibble(my_var = c(1, 2.5, 2.5, 2.5, -->
<!--                   7, 7.25, 7.25)) %>%  -->
<!--   ggplot() + -->
<!--   aes(x = my_var) + -->
<!--   geom_bar(fill = "blue", # default is   -->
<!--            alpha = .5, # widths adjusted so  -->
<!--            linetype = "dotted") + # no overlap -->
<!--   geom_bar(alpha = .5,  -->
<!--            width = .6, #setting width -->
<!--            fill = "orange") +  -->
<!--   # replacing previous aes x statement -->
<!--   # each category take up horizontal space of 1  -->
<!--   aes(x = as_factor(my_var))  -->
<!-- ``` -->




<!-- ## radar chart -->

<!-- ```{r} -->
<!-- gapminder %>%  -->
<!--   filter(continent == "Oceania") %>%  -->
<!--   select(year, country, gdpPercap) %>%  -->
<!--   group_by(country) %>%  -->
<!--   mutate(row = row_number()) %>%  -->
<!--   mutate(dist = row/n()) %>%  -->
<!--   mutate(y_pos = gdpPercap*sin(2*pi*dist)) %>%  -->
<!--   mutate(x_pos = gdpPercap*cos(2*pi*dist)) -> -->
<!-- prep -->

<!-- tibble(y = (1:8 * 4000)) %>%  -->
<!--   crossing(x = 1:12) %>%  -->
<!--   group_by(y) %>%  -->
<!--   mutate(row = row_number()) %>%  -->
<!--   mutate(dist = row/n()) %>%  -->
<!--   mutate(y_pos = y*sin(2*pi*dist)) %>%  -->
<!--   mutate(x_pos = y*cos(2*pi*dist)) %>%  -->
<!--   ggplot() + -->
<!--   aes(group = y) + -->
<!--   aes(x = x_pos) + -->
<!--   aes(y = y_pos) + -->
<!--   geom_path() + -->
<!--   geom_path(data = prep, aes(group = country), -->
<!--             color = "purple", -->
<!--             size = 4) -->

<!-- options(scipen = 30) -->
<!-- sin(pi*2*(1:6)/6) -->
<!-- ``` -->




```{css, eval = TRUE, echo = F}
.remark-code{line-height: 1.5; font-size: 55%}
```

