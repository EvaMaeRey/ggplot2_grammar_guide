---
title: "geom pile on"
author: "Gina Reynolds, July 2019"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["xaringan-themer.css", "ninjutsu"]
    nature:
      highlightLines: yes
      ratio: '16:9'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
knitr::opts_chunk$set(fig.height = 6, out.width = "100%", comment = " ", cache = T, dpi = 300)
library(flipbookr)
```


```{r, include = F}
library(tidyverse)
library(gapminder)
```

```{r prep_data, eval = T, echo = F}
gapminder %>% # data from package
  filter(year == 2002) -> # filtering
gapminder_2002 # saving subset object
gapminder_2002 %>% 
  filter(continent == "Europe") ->
gapminder_2002_europe  
gapminder %>% 
  filter(continent == "Europe") ->
gapminder_europe
gapminder %>% 
  select(country, continent) %>% 
  distinct() %>% 
  group_by(continent) %>% 
  summarise(country_count = n()) ->
continent_aggregate
```




---

# 'Nouns':  The geom_*() pile on

It is probably not good practice to include too many geoms in any one plot that you present.  But it might be instructive to go ahead do so here, to see how they relate, and represent the same underlying data.  

We can set opacity (alpha) to a high level to avoid completely blocking out previous geometric layers; this move previews the *unmapped aesthetics* topic - coming up. 

In the first example many "variables" are "computed on the fly", like the 0 represented by xend and yend and the mean of life exectency and per capita GDP. A point for discussion.  

---


> In ggplot2, geoms can be roughly divided into individual and collective geoms. An individual geom has a distinctive graphical object for each row in the data frame. For example, the point geom has a single point for each observation. On the other hand, collective geoms represent multiple observations. This may be a result of a statistical summary, or may be fundamental to the display of the geom, as with polygons. Lines and paths fall somewhere in between: each overall line is composed of a set of straight segments, but each segment represents two points. --- Hadley Wickham *ggplot2: Elegant graphics for data analysis*



---
class: inverse, center, middle
name: cc

## continous x and y


---

`r chunk_reveal("geom_2_continuous")`


```{r geom_2_continuous, eval = F, echo = F}
ggplot(gapminder_2002) +
  aes(x = gdpPercap) +
  aes(y = pop / 1000000) +
  geom_point() +
  geom_tile(width = 2500,
            height = 100,
            fill = "green",
            alpha = .25) +
  aes(xend = 0) +
  aes(yend = 0) +
  geom_segment(alpha = .2) +
  geom_curve(linetype = "dotted") +
  aes(xmin = 0) +
  aes(xmax = gdpPercap) +
  aes(ymin = 0) + 
  aes(ymax = pop / 1000000) +
  geom_rect(alpha = .3,
            fill = "magenta") +
  geom_line(linetype = "dashed") +
  aes(label = country) +
  geom_text() +
  geom_label() 
```


---

## Questions

- How is geom_tile() different from geom_point()? Look at the help.

- What aesthetics are required for geom_rect?

- How many geometric layers are in the final plot?

- Does order of the geom_*() statements matter to the end result?  How?


---
name: cc

## Two continuous variables

There are a lot of geometric objects that can be used to represent *two continuous variables*.  To explore a few more we can start a new plot.


[Or I'm on the overview track, take me to the next session](#local)

---
class: inverse, center, middle

## Two continuous, continued

---

`r chunk_reveal("geom_2_continuous_2")`


```{r geom_2_continuous_2, eval = F, echo = F}
ggplot(data = gapminder_2002 ) +
  aes(x = gdpPercap) +
  aes(y = lifeExp) +
  geom_rug(color = "plum4") +
  geom_point(col = "goldenrod2") +
  stat_density_2d(aes(fill = ..density..), 
                  geom = "raster", 
                  contour = FALSE,
                  alpha = .5) +
  geom_area(alpha = .4, 
            fill = "plum1",
            color = "plum1") +
  geom_density2d() +
  geom_smooth() + # LOESS smoothing
  geom_smooth(method = lm) + # OLS fit 
  facet_wrap(~continent)
```



---

## Questions

geom_area() is a special case of what other geom_*()?  Use the help to answer this question. 

---

Geoms is a long section consider because there are many geoms. Consider taking the [overview track](#local).

---
class: inverse, center, middle
name: dc

## Discrete v. Continuous

---


`r chunk_reveal("geom_discrete_continuous")`


```{r geom_discrete_continuous, eval = F, echo = F}
ggplot(gapminder) +
  aes(x = continent) +
  aes(y = lifeExp) +
  geom_point(size = .2) +
  geom_boxplot(alpha = .1) +
  geom_jitter(width = .2, 
              alpha = .5,
              color = "green") +
  geom_violin(alpha = .1) +
  ggforce::geom_sina(col = "magenta",
                     alpha = .5) +
  stat_summary(fun.y = mean,
               geom = "point",
               col = "goldenrod2",
               size = 8) +
  aes(x = "All Data") +
  coord_flip()
```






---
name: c

## Continuous Univariate

---

`r chunk_reveal("univariate_continuous")`


```{r, univariate_continuous, eval = F, echo = F}
ggplot(gapminder_2002) +
  aes(x = lifeExp) +
  theme_minimal() +
  geom_rug(col = "green",
           alpha = .4) +
  geom_histogram(alpha = .5,
                 fill = "red") +
  geom_dotplot(fill = "blue",
               alpha = .5) +
  geom_freqpoly(linetype = "dashed") +
  facet_grid(continent ~ .) 
```


---

`r chunk_reveal("univariate_density")`


```{r univariate_density, eval = F, echo = F}
ggplot(data = gapminder_2002) +
  aes(x = lifeExp) +
  geom_rug(col = "green",
           alpha = .6) +
  geom_histogram(col = "black", 
                 fill = "pink",
                 alpha = .4,
                 aes(y = ..density..)) +
  geom_density(linetype = "dotted",
               adjust = 1/4) +
  geom_density(linetype = "dashed",
               adjust = 1/2)
```



---
class: inverse, center, middle
name: dd

## Discrete v. Discrete

---

`r chunk_reveal("discrete2x")`


```{r discrete2x, eval = F, echo = F}
gapminder_2002 %>% 
  mutate(seventy_plus = lifeExp >= 75) %>% 
  mutate(age_category = 
           case_when(seventy_plus == T ~ 
                       "Seventy +",
                     seventy_plus == F ~ 
                       "< Seventy")) %>% 
  ggplot() +
  aes(x = continent) +
  aes(y = age_category) +
  geom_count(col = "magenta",
             alpha = .6) +
  labs(size = "Number of \ncountries") +
  geom_jitter(col = "blue",
              alpha = .3,
              width = .25,
              height = .25) +
  labs(y = NULL) +
  labs(x = NULL) +
  labs(title = "") +
  theme_minimal() 
```


---


```{r discrete2x2, eval = F, echo = F}
gapminder_2002 %>% 
  mutate(seventyfive_plus = lifeExp >= 75) %>% 
  mutate(age_category = 
           case_when(seventyfive_plus == T ~ 
                       "75+",
                     seventyfive_plus == F ~ 
                       "<75")) %>% 
  ggplot() +
  aes(x = age_category) +
  aes(fill = continent) +
  geom_bar(alpha = .4) +
  geom_bar(position = 
             position_dodge(preserve = 
                              'single')) 
```

```{r, include=FALSE}
# gapminder_2002 %>% 
#   mutate(seventy_plus = lifeExp >= 75) %>% 
#   mutate(age_category = case_when(seventy_plus == T ~ "Seventy +",
#                                   seventy_plus == F ~ "< Seventy")) %>% 
#   ggplot() +
#   aes(x = age_category) +
#   aes(group = continent) +
#     geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
#     geom_text(aes( label = scales::percent(..prop..),
#                    y = ..prop.. ), stat = "count", vjust = -.5) +
#     labs(y = "Percent", fill = "day") +
#     scale_y_continuous(labels = scales::percent) +
#     geom_text(aes(label = scales::percent(..prop..),
#                    y= ..prop.. ), stat = "count", vjust = -.5) 
```


`r chunk_reveal("discrete2x2")`

---

```{r, eval = F, echo = F}
require(stats)
mosaicplot(Titanic, main = "Survival on the Titanic", color = TRUE)

data(Titanic)
titanic <- as.data.frame(Titanic)
titanic$Survived <- factor(titanic$Survived, levels=c("Yes", "No"))

library(ggmosaic)
ggplot(data = titanic) +
  ggmosaic::geom_mosaic(aes(weight = Freq, x = product(Class), y = Sex, fill = Survived))

```


---
class: inverse, center, middle
name: group

## The group aesthetic and geometric objects


---

# A final aesthetic mapping: group

Using geom_line(), you can use many of the same aesthetics as before as well as one special aesthetic: `group`.

> Lines and paths fall somewhere in between: each overall line is composed of a set of straight segments, but each segment represents two points. --- Hadley Wickham


Group is like a declaration that instead of plotting the entire data set all together, instead you will plot many small data sets, each defined by the categorical variable "mapped" to `group`.  

Let's see how this works with the following example. 

---


`r chunk_reveal("aes_group")`



```{r aes_group, eval = F, echo = F}
gapminder_europe %>% 
  ggplot() +
  aes(x = year) +
  aes(y = lifeExp) +
  geom_point() +
  geom_line() +
  aes(group = country) +
  # turning group back off
  aes(group = NULL) + 
  # mapping discrete data to color
  # or linetype has similar effects
  aes(color = country) +
  geom_point()
```


---

The geometric object `line` connects all points as it moves along the x axis.  If a group is not defined, the geom_line is hard to interpret, as seen before group is added.  

We also see that mapping discrete data to the color or linetype aesthetics has a similar effect to declaring that there are groups in the data. 

Another thing we observe in the last addition to the last plot is adding an additional geometric layer.  The point layer, because it follows the line layer, appears on top of the line layer.  




<!-- But beyond understanding the philosophy, practice (including when things fail, and figuring out why they fail) is really important. Why initiatives like #tidytuesday are so valuable. -->

<!-- My blog post, (which no one has probably ever read) exactly on this topic! https://evangelinereynolds.netlify.com/post/mapping-aesthetics/ … In general I'd say go global.  I think in general, most folks don't have a bunch of conflicts for aesthetics geom by geom (though occasionally yes?).  Let me know what you think! -->

---


`r chunk_reveal("stat")`

```{r stat, include=F}
readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-03-03/game_goals.csv') ->
  game_goals

game_goals %>% 
  count(season) %>% 
  full_join(tibble(season = 1980:2020)) %>% 
  ggplot() +
  aes(x = season) +
  aes(y = n) +
  geom_col() + # stat is identity
  geom_point() + # stat is identity
  geom_line() + # stat is identity
  geom_area(alpha = .2, # stat is identity
            fill = "magenta") +
  aes(fill = season) ->
you_aggregate_then_plot

game_goals %>%
  ggplot() +
  aes(x = season) +
  geom_bar() + # a version of geom column
  geom_point(stat = "count") +
  geom_line(stat = "count") +
  geom_area(stat = "count",
            alpha = .2,
            fill = "magenta") +
  aes(fill = season) -> # not completely grasping why fill cant work here
ggplot_aggregates_for_you
```




```{css, eval = TRUE, echo = F}
.remark-code{line-height: 1.5; font-size: 60%}
```

