---
title: "annotate"
author: "Gina Reynolds, April 26, 2020"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["xaringan-themer.css", "ninjutsu"]
    nature:
      highlightLines: yes
      ratio: '16:9'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
knitr::opts_chunk$set(fig.height = 6, out.width = "100%", comment = " ", cache = T, dpi = 300)
library(flipbookr)
load("data_products/manipulations.Rdata")

```


```{r, include = F}
library(tidyverse)
library(gapminder)
options(scipen = 10)
```



---

name: annotate

# Exclamations and Interjections: Annotate using "geoms" not tied to data

---


```{r annotate, eval = F, echo = F}
ggplot(data = gapminder_2002) +
  aes(x = gdpPercap) +
  aes(y = lifeExp) +
  geom_point() +
  annotate(geom = "point", 
           x = 10000,
           y = 60, 
           color = "red") +
  annotate(geom = "text",
           x = c(3000, 10000, 40000),
           y = 80, 
           label = "Hello",
           color = "blue") +
  annotate(geom = "curve",
           x = 3000,
           y = 79, 
           xend = 10000 - 500,
           yend = 60 + .3,
           color = "green",
           arrow = arrow(angle = 20))
```

`r chunk_reveal("annotate")`

---

## Convenience annotation geoms

Some convenience functions have also been written for annotation using the geom_*() syntax. 

- geom_abline()
- geom_hline()
- geom_vline()

---


`r chunk_reveal("annotation_geoms")`


```{r annotation_geoms, eval = F, echo = F}
ggplot(data = gapminder_2002) +
  aes(x = gdpPercap) +
  aes(y = lifeExp) +
  geom_point() +
  geom_abline(slope = .01, intercept = 0) +
  geom_hline(yintercept = 70, 
             linetype = "dotted") +
  geom_vline(xintercept = c(1000, 10000),
             linetype = "dashed")
```


---



---

`r chunk_reveal("ref_lines", break_type = "rotate", width_code = "59%", width_output = "40%")`

```{r ref_lines, eval = F, echo = F}
library(gapminder)
gapminder %>% 
  filter(continent == "Oceania") %>% 
  ggplot() +
  aes(x = year) +
  aes(y = pop/1000000) +
  aes(linetype = country) +
  coord_cartesian(xlim = c(1952,2007), ylim = c(0, 25)) +
  geom_line(color = "steelblue") +
  geom_hline(yintercept = 10, linetype = "dotted") + #ROTATE
  geom_vline(xintercept = 1980, linetype = "dotted") + #ROTATE
  geom_abline(slope = 1, intercept = -1950, linetype = "dashed") + #ROTATE
  geom_vline(xintercept = 1980, linetype = "dotted") + #ROTATE
  annotate(geom = "rect", xmin = -Inf, xmax = Inf, ymin = 10, ymax = 15, alpha = .2) + #ROTATE
  annotate(geom = "rect", xmin = 1980, xmax = 1970, ymin = -Inf, ymax = Inf, alpha = .2) + #ROTATE
  geom_point(data = . %>% group_by(country) %>% slice(n()), aes(label = country)) + #ROTATE
  geom_text(data = . %>% group_by(country) %>% slice(n()), aes(label = country), nudge_x = -3, nudge_y = 1) + #ROTATE
  annotate(geom = "curve", curvature =   1, x = 1970, xend = 2000, y = 23, yend = 20) + #ROTATE
  annotate(geom = "curve", curvature =  .9, x = 1970, xend = 2000, y = 23, yend = 20) + #ROTATE
  annotate(geom = "curve", curvature =  .7, x = 1970, xend = 2000, y = 23, yend = 20) + #ROTATE
  annotate(geom = "curve", curvature =  .5, x = 1970, xend = 2000, y = 23, yend = 20) + #ROTATE
  annotate(geom = "curve", curvature =  .3, x = 1970, xend = 2000, y = 23, yend = 20) + #ROTATE
  annotate(geom = "curve", curvature =  .1, x = 1970, xend = 2000, y = 23, yend = 20) + #ROTATE
  annotate(geom = "curve", curvature =  .0, x = 1970, xend = 2000, y = 23, yend = 20) + #ROTATE
  annotate(geom = "curve", curvature = -.3, x = 1970, xend = 2000, y = 23, yend = 20) + #ROTATE
  annotate(geom = "curve", curvature =-1.5, x = 1970, xend = 2000, y = 23, yend = 20) + #ROTATE
  annotate(geom = "text",
           x = 1970, y = 22,
           label = "Most often\nthese geometric annotations\nare also accompanied\n by text annotation",
           hjust = 1, size = 5,
           angle = 20,
           lineheight = .8,
           fontface = "italic",
           color = "plum4")
```



---


## Using geoms for annotation


--

Geoms can also be useful for annotation.


---

`r chunk_reveal("labeling_points", break_type = "rotate", width_code = "59%", width_output = "40%")`

```{r labeling_points, include = F}
library(ggrepel)  # for the very last option 
gapminder %>% 
  filter(continent == "Asia") %>% 
  filter(year == 2002) %>% 
  ggplot() +
  aes(x = gdpPercap) +
  scale_x_log10() +
  aes(y = lifeExp) +
  coord_cartesian(xlim = c(500, 40000), ylim = c(40,85)) +
  geom_point() +
  aes(label = country) +
  geom_text() + #ROTATE
  geom_text(nudge_y = 1.25) + #ROTATE
  geom_label(nudge_y = 1.25) + #ROTATE
  geom_text(check_overlap = T, nudge_y = 1.25) + #ROTATE
  ggrepel::geom_text_repel() + #ROTATE
  shadowtext::geom_shadowtext(aes(color = lifeExp > 70)) + #ROTATE
  geom_text(data = . %>% filter(lifeExp < 60)) + #ROTATE
  geom_point(data = . %>% filter(lifeExp < 60), color = "salmon") + #ROTATE
  geom_text(data = . %>% filter(country %in% c("Vietnam", "Thailand")), color = "seagreen") + #ROTATE
  annotate(geom = "text", x = 5000, y = 58, label = "Iraq") + #ROTATE
  ggpmisc::stat_dens2d_filter(geom = "text_repel", keep.fraction = 0.5) #ROTATE 
```





---

```{r, eval = F, echo = F}
  annotate(geom = "text",
           x = 2006, y = 10,
           label = "and a nice curve",
           hjust = 1, size = 5,
           lineheight = .8,
           fontface = "italic",
           color = "plum4") +
    annotate(geom = "curve",
           x = 2006, xend = 1960,
           y = 10, yend = 20)
```



---

# Strategies for annotating time series


```{r data_prep, include=F}
library(tidyverse)

tibble(
  year = 2016:2018,
  Oranges = c(4.25, 4, 5.55),
  Lemons = c(4, 4.75, NA),
  Grapes = c(3.25, 3.75, 4.85)
)  ->
dat_wide

dat_wide %>%
  pivot_longer(
    cols = c(Oranges, Lemons, Grapes),
    names_to = "fruit",
    values_to = "price") %>%
  mutate(
    fruit_ABCD = factor(fruit),
    fruit_sane = fct_reorder2(fruit, year, price)
  ) ->
dat
```



---
class: inverse, center, middle


# Legend, ordered legend, or direct label

---



`r chunk_reveal("plots", width_code = "59%", width_output = "40%")`

```{r plots, include=F}
dat %>% 
  ggplot() +
  aes(x = year, y = price) + 
  geom_line(size = 1.5) + 
  aes(colour = fruit) + 
  theme_minimal(base_size = 25) +
  scale_x_continuous(breaks = 2016:2018) +
  labs(title = "Price of produce: Edible?") + #BREAK
  # overwrite with a more appropriate factor ordering
  aes(colour = fct_reorder2(fruit, year, price)) +
  # put the key near the data
  theme(legend.justification = c(1, 0.85)) +
  labs(colour = NULL) + 
  labs(title = "Price of produce: Fancy") + #BREAK
  # but you might directly label the series 
  theme(legend.position = "none") +
  aes(color = fruit) +
  geom_text(data = . %>% 
              group_by(fruit) %>% 
              drop_na() %>% 
              filter(year == max(year)),
            aes(label = fruit),
            nudge_x = .1,
            nudge_y = .12,
            color = "black",
            size = 7) +
  # give them a cute little end point
  geom_point(data = dat %>% 
              group_by(fruit) %>% 
              drop_na() %>% 
              filter(year == max(year)),
            aes(fill = fruit),
            shape = 21,
            size = 6,
            color = "white") +
  # but probably wider x axis
  scale_x_continuous(breaks = 2016:2018, 
                     expand = c(0.1,0),
                     limits = c(2016,2018.2)) +
  scale_y_continuous(labels = scales::dollar_format(),
                     expand = c(0,.15)) + 
  labs(x = NULL, y = NULL) +
  theme(panel.grid.minor.x = element_blank()) +
  theme(panel.grid.major.x = element_blank()) +
  theme(plot.title.position = "plot") +
  theme(plot.background = element_rect(fill = "grey98")) +
  theme(axis.line.x = element_line(color = "grey20")) + 
  theme(axis.ticks.x = element_line(color = "grey20")) +
  labs(title = "Price of produce: Extra Fancy") #BREAK
```





---
class: inverse, center, middle


# Faceting


---



`r chunk_reveal("via_faceting", width_code = "59%", width_output = "40%")`

```{r via_faceting, include=F}
dat %>% 
  ggplot() +
  aes(x = year) + 
  aes(y = price) + 
  facet_wrap(~fruit) + #ROTATE
  geom_line(data = . %>% 
              mutate(fruit_grey = fruit) %>% 
              select(-fruit),
            aes(group = fruit_grey), 
            color = "grey") +
  geom_line(size = 1.5,
            color = "steelblue") + 
  theme_minimal(base_size = 18) +
  scale_x_continuous(breaks = 2016:2018) +
  theme(legend.position = "none") +
  theme(strip.text =
          element_text(color = "steelblue", 
                       size = 20,
                       face = "bold")) +
  theme(panel.spacing.x =
          unit(2, "lines")) +
  # beyond alphabetical for faceting too
  facet_wrap(~fct_reorder2(fruit, year, price)) + #ROTATE
  labs(x = NULL, y = NULL) +
  scale_y_continuous(labels = scales::dollar_format())
```





---
class: inverse, center, middle

# Interested in the toy data prep?
--

## Uses the newish pivot_longer()!

--

### This is basically [Jenny Bryan's set up](https://gist.github.com/jennybc/847c6b43c4e35cec2e5bb30a3f38af73)


---


`r chunk_reveal("data_prep")`




---


```{css, eval = TRUE, echo = F}
.remark-code{line-height: 1.5; font-size: 60%}
```

