---
title: "ggraph"
subtitle: "With flipbookr and xaringan"
author: "Gina Reynolds, December 2019"
output:
  xaringan::moon_reader:
    seal: false
    lib_dir: libs
    css: [default, ninjutsu]
    nature:
      ratio: 16:10
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

class: left, top, inverse
background-image: url(https://images.unsplash.com/photo-1495592822108-9e6261896da8?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=1050&q=80)
background-size: 170%



# .right.large[Intro to Network Analysis/Visualization]
### .right.large[Evangeline 'Gina' Reynolds]
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>


#### Photo Credit: Pietro Jeng

```{r setup, include = F}
# This is the recommended set up for flipbooks
# you might think about setting cache to TRUE as you gain practice --- building flipbooks from scracth can be time consuming
knitr::opts_chunk$set(fig.width = 6, message = FALSE, warning = FALSE, comment = "", cache = T, fig.retina = 3)
library(flipbookr)
library(tidyverse)
```


---

## *The promise of network analysis is the placement of significance on the relationships between actors, rather than seeing actors as isolated entities.* &ndash; Jesse Sadler


--

## *Show me your company and I'll tell you who you are.* &ndash; A proverb quoted in Cervantes' Don Quixote

---


`r chunk_reveal("data_prep0")`


```{r data_prep0, include = F}
library(ggraph)
library(tidygraph)
tidygraph::create_notable(name = 
                            'zachary') %>%  
  mutate(id = 1:n()) ->
dat_minimal
```


---


# Questions to ask:

### Is my network cohesive? Is it "dense"?

--

###  Are there important individuals within the network?

--

###  Are there communities within the network?

--

###  If I see fissure in the network, along what lines might I expect to see that?


---
class: inverse

# Density

--

### Number of connections out of total possible



```{r}
choose(34, 2)
```

--

$$ \frac{n!}{(n-k)!k!} $$ 


--

```{r}
# Density
78/562
```


---
class: inverse, middle, center

# Visualizing networks


---

`r chunk_reveal("plot_karate0")`

```{r plot_karate0, include = F}
set.seed(9823)
dat_minimal %>%   
  ggraph(layout = "randomly") +
  geom_node_point() +
  geom_edge_link(color = "orange") +
  geom_node_point() +
  geom_node_point(size = 8,
                  shape = 21,
                  fill = "steelblue") + 
  geom_node_text(size = 2,
                 color = "grey97",
                 aes(label = id)
                 ) + 
  theme(plot.margin = margin(.5, .5, .5, .5, "cm"))
```


---
class: inverse, middle, center

# Layout

---

`r chunk_reveal("layout", break_type = "rotate")`

```{r layout, eval = F, echo = F}
dat_minimal %>%   
  ggraph(layout = "randomly") + #ROTATE
  ggraph(layout = "circle") + #ROTATE
  ggraph(layout = "sphere") + #ROTATE
  ggraph(layout = "kk") + #Kamada and Kawai #ROTATE
  ggraph(layout = "fr") + #Fruchterman and Reingold #ROTATE
  ggraph(layout = "auto") + #ROTATE
  ggraph(layout = "linear") + #ROTATE
  ggraph( layout = "linear", circular = TRUE) + #ROTATE
  ggraph(layout = "grid") + #ROTATE
  ggraph(layout = "star") + #ROTATE
  ggraph(layout = "dh") + #ROTATE
  ggraph(layout = "drl") + #ROTATE
  ggraph(layout = "gem") + #ROTATE
  ggraph(layout = "mds") + #ROTATE
  ggraph(layout = "lgl") + #ROTATE
  geom_edge_link(color = "orange") +
  geom_node_point() +
  geom_node_point(size = 8,
                  shape = 21,
                  fill = "steelblue") + 
  geom_node_text(size = 2,
                 color = "grey97",
                 aes(label = id)
                 ) + 
  scale_fill_viridis(discrete = T, option = 2) +
  labs(fill = NULL, color = NULL) +
  theme(plot.margin = margin(.5, .5, .5, .5, "cm"))
```

---
class: inverse, middle, center

# geom_edge_arc


---

`r chunk_reveal("layout_arc", break_type = "rotate")`

```{r layout_arc, eval = F, echo = F}
dat_minimal %>%   
  ggraph(layout = "randomly") + #ROTATE
  ggraph(layout = "circle") + #ROTATE
  ggraph(layout = "sphere") + #ROTATE
  ggraph(layout = "kk") + #Kamada and Kawai #ROTATE
  ggraph(layout = "fr") + #Fruchterman and Reingold #ROTATE
  ggraph(layout = "auto") + #ROTATE
  ggraph(layout = "linear") + #ROTATE
  ggraph( layout = "linear", circular = TRUE) + #ROTATE
  ggraph(layout = "grid") + #ROTATE
  ggraph(layout = "star") + #ROTATE
  ggraph(layout = "dh") + #ROTATE
  ggraph(layout = "drl") + #ROTATE
  ggraph(layout = "gem") + #ROTATE
  ggraph(layout = "mds") + #ROTATE
  ggraph(layout = "lgl") + #ROTATE
  geom_edge_arc(color = "orange") +
  geom_node_point() +
  geom_node_point(size = 8,
                  shape = 21,
                  fill = "steelblue") + 
  geom_node_text(size = 2,
                 color = "grey97",
                 aes(label = id)
                 ) + 
  scale_fill_viridis(discrete = T, option = 2) +
  labs(fill = NULL, color = NULL) +
  theme(plot.margin = margin(.5, .5, .5, .5, "cm"))
```

---

`r chunk_reveal("spread", break_type = "rotate")`

```{r spread, eval = F, echo = F}
set.seed(0417)
# Generate scale-free graphs according to the Barabasi Albert model
igraph::sample_pa(100, directed = T)  %>% 
  ggraph(layout = "kk") + #Kamada and Kawai #ROTATE
  ggraph(layout = "fr") + #Fruchterman and Reingold #ROTATE
  ggraph(layout = "randomly") + #ROTATE
  ggraph(layout = "circle") + #ROTATE
  ggraph(layout = "sphere") + #ROTATE
  ggraph(layout = "auto") + #ROTATE
  ggraph(layout = "linear") + geom_edge_arc(color = "orange") +#ROTATE
  ggraph( layout = "linear", circular = TRUE) + geom_edge_arc(color = "orange") + #ROTATE
  ggraph(layout = "grid") + #ROTATE
  ggraph(layout = "star") + #ROTATE
  ggraph(layout = "dh") + #ROTATE
  ggraph(layout = "drl") + #ROTATE
  ggraph(layout = "gem") + #ROTATE
  ggraph(layout = "mds") + #ROTATE
  ggraph(layout = "lgl") + #ROTATE
  geom_edge_link(color = "orange") +  
  geom_node_point(size = 5,
                  color = "steelblue",
                  alpha = .8)
```



---
class: center, middle, inverse


# Centrality

--

## Degree

--

## Betweenness

--

## Closeness




---

## Degree Centrality

--

### "Incidence upon"

--

### Who do you have immediate contact with?


---

## Closeness Centrality

--

### "The reciprocal of the farness" Bavelas (1950)

--

#### for a node 1, count the number of edges that must be traversed (shortest path) to get to node 2, to node 3, to node 4, etc...

--

#### Add these.  

--

#### Take reciprocal

--


$$ C_c(x) = \frac{1}{\sum_yd(y,x)}   $$



---

## Betweenness Centrality

#### Betweenness centrality quantifies the number of times a node acts as a bridge along the shortest path between two other nodes.

--

#### take each pair of nodes in a network

--

#### identify the shortest path between them

--

#### for each node in the network count the number of time it is an "on-the-way" nodes

<!-- --- -->


<!-- $$ C_B(x) = \frac{\sigma_{st}(V)}{\sigma_{st}} $$ -->




---

$$ C_B(x) = \frac{total~number~of~shortest~paths~passing~ throught~node}{total~number~of~shortest~paths~in~network}   $$




---

`r chunk_reveal("calculations")`


```{r calculations, include = FALSE}
dat_minimal %>% 
  activate(nodes) %>% 
  mutate(degree = 
           centrality_degree()) %>% 
  mutate(close = centrality_closeness()) %>% 
  mutate(between = 
           centrality_betweenness()) %>% 
 mutate(clique = as.factor(group_infomap())) ->
dat_centrality_calc
```

---

# Network "Decoration"

--

#### representing features of nodes or edges with variation in aesthetics (color, size, linewidth, line type)

--

#### How might we decorate our plot with centrality measures?

---


`r chunk_reveal("centrality", break_type = "rotate")`

```{r centrality, echo = F, eval = F}
dat_centrality_calc %>% 
  ggraph() +
  geom_edge_link(color = "orange") +
  geom_node_point(aes(
    size = 5, #ROTATE
    size = degree, #ROTATE
    size = close #ROTATE
    size = between, #ROTATE
  ),
  fill = "steelblue",
  shape = 21)  + 
  geom_node_text(size = 3.5,
                 color = "grey92",
                 aes(label = id)
                 ) + 
  scale_fill_viridis(discrete = T, option = 2) +
  labs(fill = NULL, color = NULL) +
  scale_size(range = c(2,8), trans = "sqrt") +
  theme_void(base_family = "Courier",
             base_size = 20) +  
  theme(plot.margin = margin(.5, .5, .5, .5, "cm"))
```

---

# Detecting communities/cliques

---

`r chunk_reveal("community")`

```{r community, echo = F, eval = F}
dat_centrality_calc %>% 
  ggraph() +
  geom_edge_link(color = "orange") +
  geom_node_point(
    aes(fill = clique,
        size = degree),
    shape = 21)  + 
  ggforce::geom_mark_hull(aes(x = x, 
                              y = y, 
                              fill = clique)) +
  scale_fill_viridis(discrete = T, option = 2) +
  labs(fill = NULL, color = NULL) +
  scale_size(range = c(2,8), trans = "sqrt") +
  theme_void(base_family = "Courier",
             base_size = 20) +  
  theme(plot.background = 
          element_rect(fill = "steelblue4",
                       color = "grey90")) +
  theme(plot.margin = margin(.5, .5, .5, .5, "cm"))
```


---




---

# Karate Club

Zachary: An Information Flow Model for Conflict and Fission in Small Groups



---

```{r data_prep, include = F}
tidygraph::create_notable(name = 
                            'zachary') %>%  
  mutate(id = 1:n()) %>% 
  mutate(leader = 
           case_when(id == 1 ~ "Mr. Hi",
                     id == 34 ~ "John A.",
                     id != 1 & id != 34 ~ 
                       "Others")) %>% 
  mutate(betweenness = centrality_betweenness()) %>% 
  mutate(leader = 
           factor(leader, 
                  levels = c("Mr. Hi", 
                             "John A.", 
                             "Others"))) ->
dat
```



---

`r chunk_reveal("plot_karate", break_type = 1)`

```{r plot_karate, include = F}
dat %>%   
  ggraph() +
  geom_edge_link(color = "orange") +
  geom_node_point() +
  geom_node_point(aes(fill = leader,
                      size = betweenness),
                  shape = 21) + 
  scale_fill_viridis(discrete = T, option = 2) +
  labs(fill = NULL, color = NULL) +
  scale_size(range = c(2,8), trans = "sqrt") +
  theme_void(base_family = "Courier",
             base_size = 20) +  
  theme(plot.background = 
          element_rect(fill = "steelblue4",
                       color = "grey90")) +
  theme(plot.margin = margin(.5, .5, .5, .5, "cm"))
```


---

# Karate Club Club

You can join the club by being the first to present your analysis of the Karate Club data at a Network Analysis conference




---

# The dyad - another relational data paradigm





# Rise of the dyad


---

.pull-left[
```{r dyadic_karate, echo=T, eval= F}
dat %>% 
  as_tibble() ->
dat_node

dat %>% 
  activate(edges) %>% 
  as_tibble() ->
dat_edges


dat_edges %>% 
  right_join(
    dat_node  %>% 
  mutate(from = id))
```
]
.pull-right[
```{r dyadic_karate1, echo = F}
dat %>% 
  as_tibble() ->
dat_node

dat %>% 
  activate(edges) %>% 
  as_tibble() ->
dat_edges


dat_edges %>% 
  right_join(
    dat_node  %>% 
  mutate(from = id))
```
]


--

- unmodeled dependence
- independence of observations

---

# Emerging concerns about the use of dyads





---
class: inverse, middle, center

# Clustering and dimension reduction


---

`r chunk_reveal("dendro")`


```{r dendro, include = F}
datasets::mtcars %>% 
  dist() %>% 
  hclust() %>% 
  ggraph() +
  geom_edge_elbow() +
  geom_node_point(aes(filter = leaf)) +
  coord_polar(theta = "x") +
  scale_y_reverse() + 
  geom_node_text(aes(x = x*1.05, y = y*1.05, filter = leaf, 
                 angle = node_angle(x, y), label = label), 
             size = 3, hjust = 'outward') 
```



---

# Reveiw


```{r, echo = F}
library(madlibs)
aeiou <- function(x){ str_replace_all(x, "[aeiou]", "-") }

```



#### Today we discussed `r aeiou("relational data and its analysis.")`  We was that there has been increased usage in the term `r aeiou("Network Visualization")` in `r aeiou("Google's ngram viewer")` &ndash; usage has been skyrocketing. Then we talked about network data structure, using the classic `r aeiou("Zachary's Karate Club")` data set as an example.   Raw network data is composed of about `r aeiou("edge lists")`, and `r aeiou("nodes lists")`.  

#### We also explored a number of network visualization `r aeiou("layouts")`.  A couple of `r aeiou("force-directed")` layouts were the Fructerman-Reingold and Kamada Kawai &ndash; different algorithms based on physical models that balancing `r aeiou("attractive")` and `r aeiou("rupulsive forces")` -- you might think of a the edges as a set of springs. These force-derected layouts contrast with geometric layouts like the `r aeiou("circle")` or `r aeiou("sphere")` or the `r aeiou("random")` layouts.

---

#### The simplest centrality measure was *degree* centrality -- which calculates "incidence upon" -- just the number of connections to the node.  The other two were `r aeiou("closeness")` centrality and `r aeiou("betweenness")`. 

#### We actually calculated characteristics of our node too measures too &ndash; `r aeiou("centrality")` measures for our network example. 

#### Sometimes, network visualizations are `r aeiou("decorated")` with variation in `r aeiou("aesthetics")` (colors, shapes, size) that represent these characteristics (line width or line type is typical for the edge list). We had size of nodes represent centrality measures in our network visualization.  


---


<!-- --- -->

<!-- ![](images_for_lecture/difference_in_difference_bdm.png) -->
<!-- --- -->




<!-- ![](images_for_lecture/replicate_bdm_stack_exchange.png) -->

<!-- ```{r, eval = F} -->
<!-- set.seed(9184) -->
<!-- LETTERS[1:10] %>%  -->
<!--   crossing(unit = ., year = 1990:1995) %>%  -->
<!--   group_by(unit) %>% -->
<!--   mutate(intervention = sample(year, 1)) %>%  -->
<!--   mutate(treated = year >= intervention) %>%  -->
<!--   mutate(outcome_null = cumsum(runif(n()))) %>%  -->
<!--   mutate(outcome = treated*5 + outcome_null) %>%  -->
<!--   ungroup() %>%  -->
<!--   ggplot() + -->
<!--   aes(group = unit) + -->
<!--   aes(y = outcome) + -->
<!--   aes(x = year) + -->
<!--   geom_point() + -->
<!--   geom_line() + -->
<!--   aes(color = treated) + -->
<!--   scale_color_manual(values = c("darkgrey", "steelblue")) + -->
<!--   facet_wrap(~unit) -->
<!-- ``` -->




<!-- --- -->

<!-- ![](images_for_lecture/difference_in_difference_bdm.png) -->












<!-- --- -->

<!-- # Flipbooks -->



<!-- --- -->

<!-- > I think I have figured it out through the flipbooks you have posted. -- Maria T. -->

<!-- --- -->

<!-- > I'm happy to advance the use of the flip books as they were incredibly helpful to learning how to code in R. I’ll probably even continue to use them for reference as I look for internships that require the use of R ... -->

<!-- --- -->

<!-- Ask my Graduate Research Assistants (R Consortium Grant funded): -->

<!-- - Suraj Tharpa -->
<!-- - Ryan Granier -->
<!-- - Britt Woodrum -->
<!-- - Conner Surracy -->
<!-- - Matt Gambino -->


<!-- --- -->

<!-- ![]() -->



```{css, eval = TRUE, echo = FALSE}
.remark-code{line-height: 1.5; font-size: 80%}
```
